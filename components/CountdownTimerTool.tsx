import React, { useState, useCallback, useEffect } from 'react';
import { useTimer, formatTime } from '../utils/TimerLogic';

const CountdownTimerTool: React.FC = () => {
  const [hoursInput, setHoursInput] = useState('0');
  const [minutesInput, setMinutesInput] = useState('25');
  const [secondsInput, setSecondsInput] = useState('0');
  const [soundEnabled, setSoundEnabled] = useState(true);
  
  const handleTimerEnd = useCallback(() => {
    if (soundEnabled) {
      try {
        const audio = new Audio("data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjQwLjEwMQAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV6urq6urq6urq6urq6urq6urq6urq6urq6v////////////////////////////////8AAAAATGF2YzU2LjQxAAAAAAAAAAAAAAAAAAAAAAAACQAAAAAAAAAASUREBAAANgAATEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//MUwA0AACx0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/8xPANQAK559f///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8AAAAA//MUwAsAFwB9f/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAAP/zFMAQABkAHX1//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwBEAGgAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAYAEgAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAcAFgAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAgAHQAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAkAIIAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAoAJIAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAsAKoAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAwAMEAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwA4AN4AdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwBAAPPAeX//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA");
        audio.play();
      } catch (error) {
        console.error("Failed to play sound:", error);
      }
    }
  }, [soundEnabled]);
  
  const calculateTotalSeconds = useCallback(() => {
    const hrs = parseInt(hoursInput, 10) || 0;
    const mins = parseInt(minutesInput, 10) || 0;
    const secs = parseInt(secondsInput, 10) || 0;
    return Math.max(0, (hrs * 3600) + (mins * 60) + secs);
  }, [hoursInput, minutesInput, secondsInput]);

  const { remainingSeconds, isRunning, start, pause, reset, setTime } = useTimer(
    calculateTotalSeconds(),
    handleTimerEnd
  );

  const isTimerZero = remainingSeconds === 0 && !isRunning;

  useEffect(() => {
    const { hours, minutes, seconds } = formatTime(remainingSeconds);
    document.title = `${hours}:${minutes}:${seconds} - Doodax Focus`;
  }, [remainingSeconds]);

  const handleSetTime = useCallback(() => {
    setTime(calculateTotalSeconds());
  }, [setTime, calculateTotalSeconds]);
  
  const handlePreset = (mins: number) => {
      setHoursInput('0');
      setMinutesInput(String(mins));
      setSecondsInput('0');
      setTime(mins * 60);
  }
  
  const handleStart = () => {
    if (isTimerZero) {
        handleSetTime();
    }
    setTimeout(() => start(), 50);
  };
  
  const handleReset = () => {
      reset(calculateTotalSeconds());
  }

  const { hours, minutes, seconds } = formatTime(remainingSeconds);
  const displayClasses = isRunning ? "opacity-100 scale-110" : "opacity-80 scale-100";
  const inputClasses = isRunning ? "opacity-0 pointer-events-none translate-y-10" : "opacity-100 translate-y-0";
  
  return (
     <div className="flex flex-col items-center justify-center w-full max-w-5xl mx-auto p-4 text-center">
      
      {/* Time Display */}
      <div className={`font-mono transition-all duration-700 ease-in-out transform ${displayClasses} mb-8`} style={{ fontSize: 'clamp(4rem, 20vw, 12rem)', lineHeight: 0.9, textShadow: '0 0 40px rgba(168, 85, 247, 0.4)'}}>
        <div className="flex items-baseline space-x-2 md:space-x-4">
            <span className="w-[1.6ch] text-right">{hours}</span>
            <span className="animate-[pulse_2s_ease-in-out_infinite] opacity-50 text-[0.8em] align-top">:</span>
            <span className="w-[1.6ch] text-center">{minutes}</span>
            <span className="animate-[pulse_2s_ease-in-out_infinite] opacity-50 text-[0.8em] align-top">:</span>
            <span className="w-[1.6ch] text-left">{seconds}</span>
        </div>
      </div>

      {/* Input Controls */}
      <div className={`transition-all duration-700 ease-in-out ${inputClasses}`}>
        <div className="flex items-end justify-center space-x-2 md:space-x-6">
            <div className="flex flex-col items-center group">
                <input type="number" value={hoursInput} onChange={(e) => setHoursInput(e.target.value)} className="w-20 md:w-32 bg-white/5 border border-white/10 hover:border-purple-500/50 text-white text-3xl md:text-5xl text-center rounded-xl p-3 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all shadow-lg backdrop-blur-sm" min="0" />
                <label className="text-xs font-bold tracking-widest text-gray-500 mt-2 group-hover:text-purple-400 transition-colors">HOURS</label>
            </div>
            <div className="flex flex-col items-center group">
                <input type="number" value={minutesInput} onChange={(e) => setMinutesInput(e.target.value)} className="w-20 md:w-32 bg-white/5 border border-white/10 hover:border-purple-500/50 text-white text-3xl md:text-5xl text-center rounded-xl p-3 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all shadow-lg backdrop-blur-sm" max="59" min="0" />
                 <label className="text-xs font-bold tracking-widest text-gray-500 mt-2 group-hover:text-purple-400 transition-colors">MINUTES</label>
            </div>
            <div className="flex flex-col items-center group">
                <input type="number" value={secondsInput} onChange={(e) => setSecondsInput(e.target.value)} className="w-20 md:w-32 bg-white/5 border border-white/10 hover:border-purple-500/50 text-white text-3xl md:text-5xl text-center rounded-xl p-3 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all shadow-lg backdrop-blur-sm" max="59" min="0" />
                 <label className="text-xs font-bold tracking-widest text-gray-500 mt-2 group-hover:text-purple-400 transition-colors">SECONDS</label>
            </div>
        </div>
         
         {/* Quick Presets */}
         <div className="flex flex-wrap justify-center gap-3 mt-8">
           {[5, 15, 25, 45, 60].map(min => (
               <button 
                key={min} 
                onClick={() => handlePreset(min)} 
                className="bg-white/10 hover:bg-purple-600 hover:shadow-purple-500/40 border border-white/5 hover:border-transparent px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 transform hover:-translate-y-1 shadow-lg backdrop-blur-sm"
               >
                 {min}m
               </button>
           ))}
        </div>
      </div>

      {/* Action Buttons */}
      <div className="flex justify-center items-center space-x-4 md:space-x-6 mt-12 z-20">
        {isRunning ? (
          <button onClick={pause} className="min-w-[140px] text-xl bg-amber-500 hover:bg-amber-400 text-black font-bold py-4 px-8 rounded-full transition-all transform hover:scale-105 shadow-[0_0_20px_rgba(245,158,11,0.4)]">PAUSE</button>
        ) : (
          <button onClick={handleStart} className="min-w-[140px] text-xl bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-4 px-10 rounded-full transition-all transform hover:scale-105 shadow-[0_0_30px_rgba(236,72,153,0.5)] tracking-wide">START</button>
        )}
        
        <button onClick={handleReset} className="p-4 bg-white/10 hover:bg-white/20 rounded-full transition-colors shadow-lg backdrop-blur-sm border border-white/10" aria-label="Reset">
           <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
        </button>

        <button onClick={() => setSoundEnabled(!soundEnabled)} className={`p-4 rounded-full transition-colors shadow-lg backdrop-blur-sm border ${soundEnabled ? 'bg-white/10 border-white/10 hover:bg-white/20' : 'bg-red-500/20 border-red-500/30 hover:bg-red-500/30'}`} aria-label="Toggle sound">
          {soundEnabled ? (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 15.858a5 5 0 01-2.828-7.072m11.314 0a1 1 0 011.414 0l.001.001a1 1 0 010 1.414l-8.485 8.485a1 1 0 01-1.414 0l-.001-.001a1 1 0 010-1.414l8.485-8.485zM12 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
          ) : (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.586 15.142A5.001 5.001 0 014 12a5 5 0 015-5 5 5 0 015 5 5 5 0 01-1.586 3.142m-4.243 4.242A9 9 0 013 12a9 9 0 019-9 9 9 0 019 9 9 9 0 01-3 6.364m-12 .001l12-12" /></svg>
          )}
        </button>
      </div>
    </div>
  );
};

export default CountdownTimerTool;